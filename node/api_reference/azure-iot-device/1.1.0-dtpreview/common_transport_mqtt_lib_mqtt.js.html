<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: common/transport/mqtt/lib/mqtt.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">
    <h1 class="page-title">Source: common/transport/mqtt/lib/mqtt.js</h1>
    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>// Copyright (c) Microsoft. All rights reserved.
// Licensed under the MIT license. See LICENSE file in the project root for full license information.

'use strict';

var MqttReceiver = require('./mqtt_receiver.js');
var debug = require('debug')('mqtt-common');
var PackageJson = require('../package.json');
var results = require('azure-iot-common').results;
var endpoint = require('azure-iot-common').endpoint;

/**
 * @class           module:azure-iot-mqtt-base.Mqtt
 * @classdesc       Base MQTT transport implementation used by higher-level IoT Hub libraries.
 *                  You generally want to use these higher-level objects (such as [azure-iot-device-mqtt.Mqtt]{@link module:azure-iot-device-mqtt.Mqtt})
 *                  rather than this one.
 *
 * @param {Object}  config      The configuration object derived from the connection string.
 */
/*Codes_SRS_NODE_COMMON_MQTT_16_004: [The `Mqtt` constructor shall instanciate the default MQTT.JS library if no argument is passed to it.]*/
/*Codes_SRS_NODE_COMMON_MQTT_16_005: [The `Mqtt` constructor shall use the object passed as argument instead of the default MQTT.JS library if it's not falsy.]*/
function Mqtt(mqttprovider) {
  this.mqttprovider = mqttprovider ? mqttprovider : require('mqtt');
}

/**
 * @method            module:azure-iot-mqtt-base.Mqtt#connect
 * @description       Establishes a secure connection to the IoT Hub instance using the MQTT protocol.
 *
 * @param {Function}  done  Callback that shall be called when the connection is established.
 */
Mqtt.prototype.connect = function (config, done) {
  /*Codes_SRS_NODE_COMMON_MQTT_16_006: [The `connect` method shall throw a ReferenceError if the config argument is falsy, or if one of the following properties of the config argument is falsy: deviceId, host, and one of sharedAccessSignature or x509.cert and x509.key.]*/
  if ((!config) ||
    (!config.host) ||
    (!config.deviceId) ||
    (!config.sharedAccessSignature &amp;&amp; (!config.x509 || !config.x509.cert || !config.x509.key))) {
    throw new ReferenceError('Invalid transport configuration');
  }

  this._receiver = null;
  this._hostName = 'mqtts://' + config.host;
  this._topicTelemetryPublish = "devices/" + config.deviceId + "/messages/events/";
  this._topicMessageSubscribe = "devices/" + config.deviceId + "/messages/devicebound/#";
  debug('topic publish: ' + this._topicTelemetryPublish);
  debug('topic subscribe: ' + this._topicMessageSubscribe);
  var versionString = encodeURIComponent('azure-iot-device/' + PackageJson.version);

  /*Codes_SRS_NODE_COMMON_MQTT_16_002: [The `connect` method shall use the authentication parameters contained in the `config` argument to connect to the server.]*/
  this._options =
  {
    cmd: 'connect',
    protocolId: 'MQTT',
    protocolVersion: 4,
    clean: false,
    clientId: config.deviceId,
    rejectUnauthorized: true,
    username: config.host + '/' + config.deviceId +
              '/DeviceClientType=' + versionString +
              '&amp;' + endpoint.versionQueryString().substr(1),
    reconnectPeriod: 0  // Client will handle reconnection at the higher level.
  };

  if (config.sharedAccessSignature) {
    this._options.password = new Buffer(config.sharedAccessSignature);
    debug('username: ' + this._options.username);
    debug('hostname: ' + this._hostName);
  } else {
    this._options.cert = config.x509.cert;
    this._options.key = config.x509.key;
    this._options.passphrase = config.x509.passphrase;
  }

  this.client = this.mqttprovider.connect(this._hostName, this._options);
  /*Codes_SRS_NODE_COMMON_MQTT_16_007: [The `connect` method shall not throw if the `done` argument has not been passed.]*/
  if (done) {
    var errCallback = function (error) {
      done(error);
    };

  /*Codes_SRS_NODE_COMMON_MQTT_16_003: [The `connect` method shall call the `done` callback with a standard javascript `Error` object if the connection failed.]*/
    this.client.on('error', errCallback);
    this.client.on('close', errCallback);
    this.client.on('offline', errCallback);
    this.client.on('disconnect', errCallback);

    this.client.on('connect', function (connack) {
      debug('Device is connected');
      debug('CONNACK: ' + JSON.stringify(connack));

      this.client.removeListener('close', errCallback);
      this.client.removeListener('offline', errCallback);
      this.client.removeListener('disconnect', errCallback);

      this.client.on('close', function () {
        debug('Device connection to the server has been closed');
        this._receiver = null;
      }.bind(this));

      /*Codes_SRS_NODE_COMMON_MQTT_12_005: [The `connect` method shall call connect on MQTT.JS  library and call the `done` callback with a `null` error object and the result as a second argument.]*/
      done(null, connack);
    }.bind(this));
  }
};

/**
 * @method            module:azure-iot-mqtt-base.Mqtt#disconnect
 * @description       Terminates the connection to the IoT Hub instance.
 *
 * @param {Function}  done      Callback that shall be called when the connection is terminated.
 */
Mqtt.prototype.disconnect = function (done) {
  this.client.removeAllListeners();
  // The first parameter decides whether the connection should be forcibly closed without waiting for all sent messages to be ACKed.
  // This should be a transport-specific parameter.
  /* Codes_SRS_NODE_HTTP_16_001: [The disconnect method shall call the done callback when the connection to the server has been closed.] */
  this.client.end(false, done);
};

/**
 * @method            module:azure-iot-mqtt-base.Mqtt#publish
 * @description       Publishes a message to the IoT Hub instance using the MQTT protocol.
 *
 * @param {Object}    message   Message to send to the IoT Hub instance.
 * @param {Function}  done      Callback that shall be called when the connection is established.
 */
/* Codes_SRS_NODE_HTTP_12_006: The PUBLISH method shall throw ReferenceError “Invalid message” if the message is falsy */
/* Codes_SRS_NODE_HTTP_12_007: The PUBLISH method shall call publish on MQTT.JS library with the given message */
Mqtt.prototype.publish = function (message, done) {
  if (!message) {
    throw new ReferenceError('Invalid message');
  }

  this.client.publish(this._topicTelemetryPublish, message.data.toString(), { qos: 1, retain: false }, function (err, puback) {
    if (done) {
      if (err) {
        done(err);
      } else {
        debug('PUBACK: ' + JSON.stringify(puback));
        done(null, new results.MessageEnqueued(puback));
      }
    }
  }.bind(this));
};

/**
 * @method              module:azure-iot-device-mqtt.Mqtt#getReceiver
 * @description         Gets a receiver object that is used to receive and settle messages.
 *
 * @param {Function}    done   callback that shall be called with a receiver object instance.
 */
/*Codes_SRS_NODE_DEVICE_MQTT_16_002: [If a receiver for this endpoint has already been created, the getReceiver method should call the done() method with the existing instance as an argument.] */
/*Codes_SRS_NODE_DEVICE_MQTT_16_003: [If a receiver for this endpoint doesn’t exist, the getReceiver method should create a new MqttReceiver object and then call the done() method with the object that was just created as an argument.] */
Mqtt.prototype.getReceiver = function (done) {
  if (!this._receiver) {
    this._receiver = new MqttReceiver(
      this.client,
      this._topicMessageSubscribe
    );
  }

  done(null, this._receiver);
};

module.exports = Mqtt;
</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Modules</h3><ul><li><a href="module-azure-iot-amqp-base.html">azure-iot-amqp-base</a></li><li><a href="module-azure-iot-common.html">azure-iot-common</a></li><li><a href="module-azure-iot-device.html">azure-iot-device</a></li><li><a href="module-azure-iot-device-amqp.html">azure-iot-device-amqp</a></li><li><a href="module-azure-iot-device-amqp-ws.html">azure-iot-device-amqp-ws</a></li><li><a href="module-azure-iot-device-http.html">azure-iot-device-http</a></li><li><a href="module-azure-iot-device-mqtt.html">azure-iot-device-mqtt</a></li><li><a href="module-azure-iot-http-base.html">azure-iot-http-base</a></li><li><a href="module-azure-iot-mqtt-base.html">azure-iot-mqtt-base</a></li></ul><h3>Classes</h3><ul><li><a href="module-azure-iot-amqp-base.Amqp.html">azure-iot-amqp-base.Amqp</a></li><li><a href="module-azure-iot-amqp-base.AmqpMessage.html">azure-iot-amqp-base.AmqpMessage</a></li><li><a href="module-azure-iot-amqp-base.AmqpReceiver.html">azure-iot-amqp-base.AmqpReceiver</a></li><li><a href="module-azure-iot-common.ArgumentError.html">azure-iot-common.ArgumentError</a></li><li><a href="module-azure-iot-common.BadDeviceResponseError.html">azure-iot-common.BadDeviceResponseError</a></li><li><a href="module-azure-iot-common.DeviceMaximumQueueDepthExceededError.html">azure-iot-common.DeviceMaximumQueueDepthExceededError</a></li><li><a href="module-azure-iot-common.DeviceNotFoundError.html">azure-iot-common.DeviceNotFoundError</a></li><li><a href="module-azure-iot-common.DeviceTimeoutError.html">azure-iot-common.DeviceTimeoutError</a></li><li><a href="module-azure-iot-common.FormatError.html">azure-iot-common.FormatError</a></li><li><a href="module-azure-iot-common.GatewayTimeoutError.html">azure-iot-common.GatewayTimeoutError</a></li><li><a href="module-azure-iot-common.Message.html">azure-iot-common.Message</a></li><li><a href="module-azure-iot-common.SharedAccessSignature.html">azure-iot-common.SharedAccessSignature</a></li><li><a href="module-azure-iot-common.TimeoutError.html">azure-iot-common.TimeoutError</a></li><li><a href="module-azure-iot-common.UnauthorizedError.html">azure-iot-common.UnauthorizedError</a></li><li><a href="module-azure-iot-device.Client.html">azure-iot-device.Client</a></li><li><a href="module-azure-iot-device-amqp.Amqp.html">azure-iot-device-amqp.Amqp</a></li><li><a href="module-azure-iot-device-amqp-ws.AmqpWs.html">azure-iot-device-amqp-ws.AmqpWs</a></li><li><a href="module-azure-iot-device-http.Http.html">azure-iot-device-http.Http</a></li><li><a href="module-azure-iot-device-http.HttpReceiver.html">azure-iot-device-http.HttpReceiver</a></li><li><a href="module-azure-iot-device-mqtt.Mqtt.html">azure-iot-device-mqtt.Mqtt</a></li><li><a href="module-azure-iot-http-base.Http.html">azure-iot-http-base.Http</a></li><li><a href="module-azure-iot-mqtt-base.Mqtt.html">azure-iot-mqtt-base.Mqtt</a></li></ul><h3>Events</h3><ul><li><a href="module-azure-iot-amqp-base.AmqpReceiver.html#event:errorReceived">azure-iot-amqp-base.AmqpReceiver#errorReceived</a></li><li><a href="module-azure-iot-amqp-base.AmqpReceiver.html#event:message">azure-iot-amqp-base.AmqpReceiver#message</a></li><li><a href="module-azure-iot-device-http.HttpReceiver.html#event:errorReceived">azure-iot-device-http.HttpReceiver#errorReceived</a></li><li><a href="module-azure-iot-device-http.HttpReceiver.html#event:message">azure-iot-device-http.HttpReceiver#message</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.4.0</a> on Mon Oct 10 2016 15:52:47 GMT-0700 (Pacific Daylight Time)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
